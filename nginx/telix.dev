# telix.dev — production nginx config

upstream telix_backend {
    server 127.0.0.1:3000;
    keepalive 8;
}

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name telix.dev www.telix.dev;
    return 301 https://telix.dev$request_uri;
}

# www → non-www redirect (HTTPS)
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name www.telix.dev;

    include snippets/ssl-telix.conf;

    return 301 https://telix.dev$request_uri;
}

# Main server block
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name telix.dev;

    include snippets/ssl-telix.conf;
    include snippets/cloudflare.conf;

    root /var/www/telix.dev/frontend;
    index index.html;

    # Security headers
    include snippets/security-headers-telix.conf;

    # Block sensitive paths
    location ~ /\.env { deny all; return 404; }
    location ~ /CLAUDE\.md { deny all; return 404; }
    location ~ /node_modules/ { deny all; return 404; }
    location ~ /package\.json { deny all; return 404; }
    location ~ /backend/ { deny all; return 404; }
    location ~ /data/ { deny all; return 404; }

    # Static assets — long cache
    location /css/ {
        include snippets/security-headers-telix.conf;
        add_header Cache-Control "public, max-age=2592000" always;
        access_log off;
    }

    location /js/ {
        include snippets/security-headers-telix.conf;
        add_header Cache-Control "public, max-age=2592000" always;
        access_log off;
    }

    location /fonts/ {
        include snippets/security-headers-telix.conf;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        access_log off;
    }

    # WebSocket terminal proxy
    location /ws/terminal {
        proxy_pass http://telix_backend;
        include snippets/proxy-params.conf;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 1200s;
    }

    # API proxy
    location /api/ {
        limit_req zone=telix_api burst=30 nodelay;

        proxy_pass http://telix_backend;
        include snippets/proxy-params.conf;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # No-cache index.html
    location = /index.html {
        include snippets/security-headers-telix.conf;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header Pragma "no-cache" always;
    }

    # Logging
    access_log /var/log/nginx/telix.dev.access.log;
    error_log /var/log/nginx/telix.dev.error.log;
}
